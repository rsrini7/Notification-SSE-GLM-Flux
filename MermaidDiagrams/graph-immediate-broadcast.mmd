graph TD
    subgraph "Start"
        A["Admin Creates an Immediate Broadcast <br/> (ALL, ROLE, or SELECTED)"]
    end

    A --> C[Admin Service publishes ONE <br/> orchestration event via the Outbox Pattern];
    subgraph "Orchestration (Fan-out on Read)"
        C --> D[Kafka: broadcast-orchestration topic];
        D --> E["User Service (Orchestrator Pod) <br/> consumes the single event"];
        E --> F["Dynamically determines target user list <br/> & looks up their pod locations in Geode"];
        F --> G["'Scatters' N user-specific events by <br/> PUT-ting them into the 'sse-user-messages' Geode region"];
    end
    
    subgraph "Delivery (Worker Pods)"
        G --> J["Apache Geode Server"];
        J -- "Notifies clients via<br/>Continuous Query (CQ)" --> K["User Service (Worker Pods) <br/> CqListener is invoked with relevant events"];
        K --> L[Push message to online user via SSE <br/> or cache for offline user in Geode"];
    end