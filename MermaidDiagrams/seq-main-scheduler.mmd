sequenceDiagram
    autonumber

    participant Scheduler as BroadcastActivationService
    participant DB as PostgreSQL DB
    participant TargetingSvc as BroadcastTargetingService (Async)
    participant LifecycleSvc as BroadcastLifecycleService

    loop Every 1 Minute
        note over Scheduler: Unified scheduler wakes up (processDueBroadcasts method)

        %% Phase 1: Find and start pre-computation for complex broadcasts
        Scheduler->>+DB: 1- Finds upcoming PRODUCT broadcasts to prepare
        DB-->>-Scheduler: 
        
        loop For each broadcast to prepare
            Scheduler->>DB: 2- UPDATE status to 'PREPARING' to claim it
            Scheduler-)+TargetingSvc: 3- Kicks off async pre-computation
        end

        %% Phase 2: Activate broadcasts that are already prepared and ready
        Scheduler->>+DB: 4- Finds READY broadcasts to activate now
        DB-->>-Scheduler: 
        
        loop For each READY broadcast
            Scheduler->>+LifecycleSvc: 5- processReadyBroadcast(id)
            LifecycleSvc-->>-Scheduler: 
        end

        %% Phase 3: Activate simple scheduled broadcasts that don't need pre-computation
        Scheduler->>+DB: 6- Finds SCHEDULED (ALL/ROLE/SELECTED) broadcasts to activate now
        DB-->>-Scheduler: 
        
        loop For each simple SCHEDULED broadcast
            Scheduler->>+LifecycleSvc: 7- activateAndPublish...Broadcast(id)
            LifecycleSvc-->>-Scheduler: 
        end
    end