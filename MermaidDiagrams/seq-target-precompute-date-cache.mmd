sequenceDiagram
    autonumber

    participant TargetingSvc as Admin Service (Targeting)
    participant DB as PostgreSQL DB
    participant OutboxPoller as Admin Service (Poller)
    participant Kafka
    participant Orchestrator as User Service (Consumer)
    participant GeodeCache

    note over TargetingSvc, DB: Pre-computation for a PRODUCT broadcast completes.
    TargetingSvc->>+DB: 1- Saves user list to 'broadcast_user_targets' table
    DB-->>-TargetingSvc: ...

    note over TargetingSvc: Instead of caching, it now publishes an event.
    TargetingSvc->>+DB: 2- Writes 'TARGETS_PRECOMPUTED' event to Outbox
    DB-->>-TargetingSvc: ...

    OutboxPoller->>+Kafka: 3- Polls Outbox and publishes the event
    Kafka-->>-OutboxPoller: ...

    Kafka->>+Orchestrator: 4- Delivers 'TARGETS_PRECOMPUTED' event
    
    note over Orchestrator: The User Service is now responsible for caching.
    Orchestrator->>+DB: 5- Reads the pre-computed user list from 'broadcast_user_targets'
    DB-->>-Orchestrator: Returns user list

    Orchestrator-->>-Kafka: 6- Acknowledges Kafka message