graph TD
    subgraph "Frontend"
        AdminUI[Admin UI]
    end

    subgraph "Admin Service (Control Plane)"
        AdminAPI["1- API Layer"]
        LifecycleSvc["2- BroadcastLifecycleService"]
        
        subgraph "Background Processing Schedulers"
            direction TB
            PrecomputationScheduler["4a- Precomputation Scheduler"]
            ActivationScheduler["6- Activation Scheduler"]
            OutboxPoller["8- Outbox Polling Service"]
        end
        AsyncPrecomputation["5a- Async Precomputation"]
    end
    
    subgraph "User Service (Delivery Plane)"
        OrchestratorConsumer["10- Orchestrator Consumer (Kafka)"]
        WorkerRedisListener["12- Worker Redis Listener"]
        SseService["13- SSE Service"]
    end

    subgraph "Shared Infrastructure"
        Postgres["PostgreSQL DB"]
        Kafka["Kafka Broker"]
        Redis["Redis (Cache & Pub/Sub)"]
    end

    %% --- Flow ---
    AdminUI --> AdminAPI --> LifecycleSvc --> CreationLogic{"3- Creation Logic"}

    CreationLogic -- "Immediate ALL/ROLE/SELECTED" --> SaveActiveAndOutbox["DB: status=ACTIVE<br/>INSERT into outbox_events"]
    CreationLogic -- "Immediate PRODUCT" --> SavePreparing["DB: status=PREPARING"]
    SaveActiveAndOutbox --> Postgres
    SavePreparing --> Postgres
    
    SavePreparing -- "Triggers" --> AsyncPrecomputation
    AsyncPrecomputation -- "Saves targets & sets status=READY" --> Postgres

    ActivationScheduler -- "Polls for READY" --> Postgres
    ActivationScheduler -- "7- DB: status=ACTIVE<br/>INSERT into outbox_events" --> Postgres
    
    Postgres -- "Event waits in 'outbox_events'" --> OutboxPoller
    OutboxPoller -- "Publishes ONE Orchestration Event" --> Kafka

    Kafka -- "9- Orchestration Topic" --> OrchestratorConsumer
    OrchestratorConsumer -- "Determines Audience & Pod Location" --> Redis
    OrchestratorConsumer -- "11- Publishes to Redis Channels" --> Redis
    Redis -- "Delivers to correct Pod" --> WorkerRedisListener
    WorkerRedisListener --> SseService
    SseService -- "Pushes via SSE" --> User[User Browser]