graph TD
    subgraph "Container Boundary: User Service"
        direction LR

        subgraph "API Layer"
            UserControllers["<div style='font-weight:bold'>*User & SSE Controllers*</div><div style='font-size: smaller;'>Spring @RestController</div><div style='font-size: smaller;'>Handles user API calls and establishes persistent SSE connections.</div>"]
        end

        subgraph "Real-time & Service Layer"
            SseService["<div style='font-weight:bold'>SseService</div><div style='font-size: smaller;'>High-level service for managing SSE event streams and logic.</div>"]
            SseManager["<div style='font-weight:bold'>SseConnectionManager</div><div style='font-size: smaller;'>Low-level, in-memory management of active SSE sinks on this pod.</div>"]
            UserMessageService["<div style='font-weight:bold'>UserMessageService</div><div style='font-size: smaller;'>Handles business logic for user messages (fetching, marking as read).</div>"]
        end
        
        subgraph "Event Consumers"
            Orchestrator["<div style='font-weight:bold'>KafkaOrchestratorConsumerService</div><div style='font-size: smaller;'>*Kafka Consumer*<br/>Consumes orchestration events from Kafka.</div>"]
            RedisListener["<div style='font-weight:bold'>RedisMessageListener</div><div style='font-size: smaller;'>*Redis Subscriber*<br/>Receives user-specific events from Redis Pub/Sub channels.</div>"]
        end

        subgraph "Data Access & Distributed State"
            Repositories["<div style='font-weight:bold'>Repositories</div><div style='font-size: smaller;'>- UserBroadcastRepository<br/>- BroadcastRepository</div>"]
            RedisManager["<div style='font-weight:bold'>RedisCacheService</div><div style='font-size: smaller;'>Manages distributed state in Redis (user presence, cache, Pub/Sub).</div>"]
        end
    end

    %% External Systems
    UserUI[User UI]
    Kafka[Kafka Broker]
    Postgres[PostgreSQL DB]
    Redis[Redis Cache & Pub/Sub]
    
    %% Relationships
    UserUI -- "HTTPS / SSE" --> UserControllers
    UserControllers --> SseService
    UserControllers --> UserMessageService
    
    SseService --> SseManager
    SseService --> RedisManager
    UserMessageService --> Repositories
    UserMessageService --> RedisManager

    Orchestrator -- "Consumes Orchestration Events" --> Kafka
    Orchestrator -- "Publishes to Redis Channels" --> RedisManager
    
    RedisListener -- "Subscribes to Redis Channels" --> RedisManager
    RedisListener --> SseService
    
    Repositories --> Postgres
    RedisManager --> Redis