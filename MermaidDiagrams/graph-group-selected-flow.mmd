graph TD
    subgraph "Start"
        A[Admin Creates Broadcast]
    end

    A --> B{"Is TargetType 'ALL'/'ROLE' <br/> or 'SELECTED'?"};

    subgraph "Path 1: ALL / ROLE (Scatter-Gather Pattern)"
        B -- "ALL / ROLE" --> C[Admin Service <br/> Publishes ONE Event];
        C --> D[Kafka: broadcast-orchestration];
        D --> E["User Service (Orchestrator) <br/> Consumes the single event"];
        E --> F[Reads full user list from DB];
        F --> G["Scatters" N events to worker topics];
    end

    subgraph "Path 2: SELECTED (Direct-to-Worker Pattern)"
        B -- "SELECTED" --> H[Admin Service <br/> Reads N user pod locations from Redis];
        H --> I[Publishes N events directly to worker topics];
    end
    
    subgraph "Finish: Common Delivery Path"
        G --> J[Kafka: Worker Topics];
        I --> J;
        J --> K["User Service (Worker Pods) <br/> Consume user-specific events"];
        K --> L[Push message via SSE];
    end

    %% Styles
    classDef admin fill:#fff2cc,stroke:#333;
    classDef user fill:#e2f0d9,stroke:#333;
    classDef kafka fill:#cce5ff,stroke:#333;

    class C,H,I admin;
    class E,F,G,K,L user;
    class D,J kafka;