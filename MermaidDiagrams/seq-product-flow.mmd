sequenceDiagram
    autonumber

    participant AdminUI
    participant AdminSvc as Admin Service (Targeting)
    participant DB
    participant Kafka
    participant UserSvc as User Service (Consumer)
    participant GeodeCache
    participant Scheduler as BroadcastSchedulingService
    
    note over AdminUI, DB: Stage 1: Pre-computation & Cache Priming
    AdminUI->>+AdminSvc: 1- POST /broadcasts (targetType=PRODUCT)
    AdminSvc->>+DB: 2- INSERT broadcast (status='PREPARING')
    AdminSvc-->>-AdminUI: 3- 202 Accepted

    note over AdminSvc: Async pre-computation begins...
    AdminSvc->>+DB: 4- Saves full user list to 'broadcast_user_targets'
    AdminSvc->>+DB: 5- Writes 'TARGETS_PRECOMPUTED' event to Outbox
    AdminSvc->>+DB: 6- UPDATE broadcast status to 'READY'
    
    note over AdminSvc, Kafka: Outbox poller publishes the event...
    DB-->>-AdminSvc: ...
    
    Kafka->>+UserSvc: 7- Delivers 'TARGETS_PRECOMPUTED' event
    UserSvc->>+DB: 8- Reads user list from 'broadcast_user_targets'
    DB-->>-UserSvc: ...
    UserSvc->>+GeodeCache: 9- Caches user list in 'precomputed-targets' region
    GeodeCache-->>-UserSvc: ...
    UserSvc-->>-Kafka: 10- Acknowledges Kafka message

    note over AdminUI, DB: Stage 2: Scheduled Activation
    note over Scheduler, DB: ...Time passes...
    Scheduler->>+DB: 11- Finds READY broadcast
    DB-->>-Scheduler: ...
    
    Scheduler->>+AdminSvc: 12- Activates the broadcast
    AdminSvc->>+DB: 13- UPDATE status to 'ACTIVE' & Writes CREATED event to Outbox
    DB-->>-AdminSvc: ...
    note over AdminSvc: Delivery flow for the main CREATED event now begins...