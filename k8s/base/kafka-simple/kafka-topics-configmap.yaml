# file: k8s/base/kafka-simple/kafka-topics-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-topics-script
  namespace: broadcast-system
data:
  create-kafka-topics.sh: |
    #!/bin/bash
    # This script is for a multi-cluster Kubernetes environment.
    # It's designed to be run from within the cluster.
    
    # This should be the address of your Kafka service within the Kubernetes cluster.
    KAFKA_BROKERS="kafka-service.broadcast-system.svc.cluster.local:9092"
    CLUSTER_NAMES=("cluster-a" "cluster-b" "cluster-c" "cluster-d")
    MAX_REPLICAS=10

    # --- Wait for Kafka to be ready ---
    echo "Waiting for Kafka broker at $KAFKA_BROKERS to be ready..."
    # Use a loop with kafka-topics to check for connectivity.
    until kafka-topics.sh --bootstrap-server $KAFKA_BROKERS --list > /dev/null 2>&1
    do
      echo "Kafka not ready, sleeping for 5 seconds..."
      sleep 5
    done
    echo "Kafka is ready!"

    # --- Create Singleton Topics ---
    ORCHESTRATION_TOPIC="broadcast-orchestration"
    ORCHESTRATION_DLT="${ORCHESTRATION_TOPIC}-dlt"
    WORKER_DLT="broadcast-events-dlt"

    echo "--- Creating Singleton Topics ---"
    kafka-topics.sh --bootstrap-server $KAFKA_BROKERS --create --if-not-exists --topic $ORCHESTRATION_TOPIC --partitions 1 --replication-factor 3
    kafka-topics.sh --bootstrap-server $KAFKA_BROKERS --create --if-not-exists --topic $ORCHESTRATION_DLT --partitions 1 --replication-factor 3
    kafka-topics.sh --bootstrap-server $KAFKA_BROKERS --create --if-not-exists --topic $WORKER_DLT --partitions 1 --replication-factor 3

    # --- Create Pod-Specific Worker Topics ---
    echo ""
    echo "--- Creating Pod-Specific Worker Topics ---"
    WORKER_TOPIC_PREFIX="broadcast-events-"

    for cluster in "${CLUSTER_NAMES[@]}"; do
      for ((i=0; i<$MAX_REPLICAS; i++)); do
        # The pod name from a StatefulSet is stable: <statefulset-name>-<index>
        # The app logic will combine the prefix with the pod name's index.
        # Example topic name: cluster-a-broadcast-events-0
        TOPIC_NAME="${cluster}-${WORKER_TOPIC_PREFIX}${i}"
        echo "Creating topic: $TOPIC_NAME"
        kafka-topics.sh --bootstrap-server $KAFKA_BROKERS --create --if-not-exists --topic $TOPIC_NAME --partitions 1 --replication-factor 3
      done
    done

    echo "--- Topic creation script finished successfully. ---"